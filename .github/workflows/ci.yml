name: CI

on:
    push:
        branches: [ "main", "master" ]
    pull_request:
        branches: [ "**" ]

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # =============================================================
    # PFAD-FILTER (Ressourcen-Optimierung)
    # =============================================================
    changes:
        name: ğŸ” Detect Changes
        runs-on: ubuntu-latest
        outputs:
            backend: ${{ steps.filter.outputs.backend }}
            mobile: ${{ steps.filter.outputs.mobile }}
            ios: ${{ steps.filter.outputs.ios }}
            e2e: ${{ steps.filter.outputs.e2e }}
        steps:
            -   uses: actions/checkout@v4
            -   uses: dorny/paths-filter@v3
                id: filter
                with:
                    filters: |
                        backend:
                          - 'backend/**'
                          - 'tools/**'
                          - '.github/workflows/ci.yml'
                          - '.github/actions/setup-backend/**'
                        mobile:
                          - 'mobile/**'
                          - 'tools/**'
                          - '.github/workflows/ci.yml'
                          - '.github/actions/setup-mobile/**'
                        ios:
                          - 'ios/**'
                          - 'tools/**'
                          - '.github/workflows/ci.yml'
                        e2e:
                          - 'backend/**'
                          - 'mobile/**'
                          - 'tests/e2e/**'
                          - 'tools/**'
                          - '.github/workflows/ci.yml'
                          - '.github/actions/**'

    # =============================================================
    # BACKEND-PRÃœFUNGEN
    # =============================================================
    backend-check:
        name: ğŸ Backend Quality & Tests
        needs: [ changes ]
        if: needs.changes.outputs.backend == 'true'
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Setup Backend
                uses: ./.github/actions/setup-backend

            -   name: ğŸ” Python-Umgebung prÃ¼fen
                run: |
                    echo "::group::Python-Umgebung"
                    python3 --version
                    pip --version
                    echo "::endgroup::"

            -   name: âœ¨ Backend-QualitÃ¤t (Ruff + MyPy)
                run: |
                    bash tools/dev/pipeline/ci_steps.sh backend_quality

            -   name: ğŸ§ª Backend Unit-Tests
                run: |
                    bash tools/dev/pipeline/ci_steps.sh backend_unit_tests

            -   name: ğŸ§ª Backend Integrationstests
                run: |
                    bash tools/dev/pipeline/ci_steps.sh backend_integration_tests

            -   name: ğŸ§ª E2E Contract Tests
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_contract_tests

    # =============================================================
    # MOBILE-PRÃœFUNGEN
    # =============================================================
    mobile-check:
        name: ğŸ“± Mobile Quality & Tests
        needs: [ changes ]
        if: needs.changes.outputs.mobile == 'true'
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Setup Mobile
                uses: ./.github/actions/setup-mobile

            -   name: ğŸ” Node-Umgebung prÃ¼fen
                run: |
                    echo "::group::Node-Umgebung"
                    node --version
                    npm --version
                    echo "::endgroup::"

            -   name: ğŸš‘ Expo-Konfiguration (expo-doctor)
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_expo_doctor

            -   name: âœ¨ Mobile Linting
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_lint

            -   name: ğŸ” Mobile TypeScript-Check
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_typescript_check

            -   name: â™»ï¸ Restore Jest/Babel Cache
                uses: actions/cache@v4
                with:
                    path: |
                        mobile/.cache/jest
                        mobile/.cache/babel.json
                    key: jest-babel-${{ runner.os }}-${{ hashFiles('mobile/package-lock.json') }}

            -   name: ğŸ§ª Mobile Tests
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_jest_tests

            -   name: ğŸ“¦ Mobile Build
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_build

    # =============================================================
    # IOS-JOB (MacOS fÃ¼r Xcode)
    # =============================================================
    ios-check:
        name: ğŸ iOS Build & Sanity
        needs: [ changes ]
        if: needs.changes.outputs.ios == 'true'
        runs-on: macos-latest
        permissions:
            contents: read
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: ğŸ› ï¸ Install Bash 5 (macOS)
                run: |
                    brew install bash
                    echo "/opt/homebrew/bin" >> $GITHUB_PATH

            -   name: ğŸ” iOS Project Sanity Check
                run: |
                    bash tools/dev/pipeline/ci_steps.sh ios_project_sanity

            -   name: ğŸ“¦ iOS Resolve Dependencies
                run: |
                    bash tools/dev/pipeline/ci_steps.sh ios_resolve_deps

            -   name: ğŸ“¦ iOS Build
                run: |
                    bash tools/dev/pipeline/ci_steps.sh ios_build

            -   name: ğŸ§ª iOS Tests
                run: |
                    bash tools/dev/pipeline/ci_steps.sh ios_tests

    # =============================================================
    # CI GATE: Health + Demo-Feed + Playwright Gate Spec
    # =============================================================
    e2e-ci-gate:
        name: ğŸ©º E2E System Gate
        needs: [ changes, backend-check, mobile-check ]
        if: |
            always() && 
            needs.changes.outputs.e2e == 'true' &&
            (needs.backend-check.result == 'success' || needs.backend-check.result == 'skipped') &&
            (needs.mobile-check.result == 'success' || needs.mobile-check.result == 'skipped')
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Setup Backend
                uses: ./.github/actions/setup-backend

            -   name: ğŸš€ Backend im E2E-Modus starten
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_backend_start

            -   name: Setup Mobile
                uses: ./.github/actions/setup-mobile

            -   name: ğŸš€ Expo-Web im E2E-Modus starten
                env:
                    EXPO_PUBLIC_API_BASE_URL: http://127.0.0.1:8100
                    HW_PROFILE: e2e
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_expo_web_start

            -   name: ğŸ©º System Gate Checks (Health + Demo-Feed)
                env:
                    E2E_API_BASE_URL: http://127.0.0.1:8100
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_gate_checks

            -   name: ğŸ­ Playwright-Dependencies installieren
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_playwright_install

            -   name: ğŸŒ Playwright Gate Spec
                env:
                    PLAYWRIGHT_WEB_BASE_URL: http://localhost:19006
                    E2E_API_BASE_URL: http://127.0.0.1:8100
                    HW_PROFILE: e2e
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_playwright_gate_tests

    # =============================================================
    # BROWSER E2E (Playwright â€“ Minimal)
    # =============================================================
    e2e-core-minimal:
        name: ğŸ­ E2E Minimal
        needs: [ changes, e2e-ci-gate ]
        if: needs.changes.outputs.e2e == 'true' && needs.e2e-ci-gate.result == 'success'
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Setup Backend
                uses: ./.github/actions/setup-backend

            -   name: ğŸš€ Backend im E2E-Modus starten
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_backend_start

            -   name: Setup Mobile
                uses: ./.github/actions/setup-mobile

            -   name: ğŸš€ Expo-Web im E2E-Modus starten
                env:
                    EXPO_PUBLIC_API_BASE_URL: http://127.0.0.1:8100
                    HW_PROFILE: e2e
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_expo_web_start

            -   name: ğŸ­ Playwright-Dependencies installieren
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_playwright_install

            -   name: ğŸŒ E2E Browser Tests (Playwright â€“ Minimal)
                env:
                    PLAYWRIGHT_WEB_BASE_URL: http://localhost:19006
                    E2E_API_BASE_URL: http://127.0.0.1:8100
                    HW_PROFILE: e2e
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_playwright_minimal_tests

    # =============================================================
    # BROWSER E2E (Playwright â€“ STANDARD)
    # =============================================================
    e2e-core-standard:
        name: ğŸ­ E2E Standard
        needs: [ changes, e2e-ci-gate ]
        if: needs.changes.outputs.e2e == 'true' && needs.e2e-ci-gate.result == 'success'
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Setup Backend
                uses: ./.github/actions/setup-backend

            -   name: ğŸš€ Backend im E2E-Modus starten
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_backend_start

            -   name: Setup Mobile
                uses: ./.github/actions/setup-mobile

            -   name: ğŸš€ Expo-Web im E2E-Modus starten
                env:
                    EXPO_PUBLIC_API_BASE_URL: http://127.0.0.1:8100
                    HW_PROFILE: e2e
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_expo_web_start

            -   name: ğŸ­ Playwright-Dependencies installieren
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_playwright_install

            -   name: ğŸŒ E2E Browser Tests (Playwright â€“ Standard)
                env:
                    PLAYWRIGHT_WEB_BASE_URL: http://localhost:19006
                    E2E_API_BASE_URL: http://127.0.0.1:8100
                    HW_PROFILE: e2e
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_playwright_standard_tests

    # =============================================================
    # ABSCHLUSS
    # =============================================================
    finish:
        name: âœ… CI Success
        runs-on: ubuntu-latest
        needs: [ changes, backend-check, mobile-check, ios-check, e2e-ci-gate, e2e-core-minimal, e2e-core-standard ]
        if: always()
        steps:
            - name: Verify all jobs success or skipped
              if: >
                (needs.backend-check.result == 'success' || needs.backend-check.result == 'skipped') &&
                (needs.mobile-check.result == 'success' || needs.mobile-check.result == 'skipped') &&
                (needs.ios-check.result == 'success' || needs.ios-check.result == 'skipped') &&
                (needs.e2e-ci-gate.result == 'success' || needs.e2e-ci-gate.result == 'skipped') &&
                (needs.e2e-core-minimal.result == 'success' || needs.e2e-core-minimal.result == 'skipped') &&
                (needs.e2e-core-standard.result == 'success' || needs.e2e-core-standard.result == 'skipped')
              run: |
                echo "::notice::Alle relevanten CI-Jobs wurden erfolgreich abgeschlossen (oder Ã¼bersprungen)."
            - name: Fail if any job failed
              if: >
                needs.backend-check.result == 'failure' ||
                needs.mobile-check.result == 'failure' ||
                needs.ios-check.result == 'failure' ||
                needs.e2e-ci-gate.result == 'failure' ||
                needs.e2e-core-minimal.result == 'failure' ||
                needs.e2e-core-standard.result == 'failure'
              run: |
                echo "Mindestens ein Job ist fehlgeschlagen."
                exit 1