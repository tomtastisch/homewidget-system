name: CI

on:
    push:
        branches: [ "main", "master" ]
    pull_request:
        branches: [ "**" ]

jobs:
    build-and-check:
        runs-on: ubuntu-latest
        permissions:
            contents: read

        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            # =============================================================
            # BACKEND-UMGEBUNG
            # =============================================================

            -   name: ğŸ Python 3.13 einrichten
                uses: actions/setup-python@v5
                with:
                    python-version: '3.13'
                    cache: 'pip'
                    cache-dependency-path: |
                        backend/pyproject.toml
                        backend/setup.py
                        backend/requirements*.txt

            -   name: ğŸ” Python-Umgebung prÃ¼fen
                run: |
                    echo "::group::Python-Umgebung"
                    python3 --version
                    pip --version
                    echo "::endgroup::"

            -   name: ğŸ“¦ Backend-Setup
                run: |
                    bash tools/dev/pipeline/ci_steps.sh backend_setup_env

            -   name: âœ¨ Backend-QualitÃ¤t (Ruff + MyPy)
                run: |
                    bash tools/dev/pipeline/ci_steps.sh backend_quality

            -   name: ğŸ§ª Backend Unit-Tests
                run: |
                    bash tools/dev/pipeline/ci_steps.sh backend_unit_tests

            -   name: ğŸ§ª Backend Integrationstests
                run: |
                    bash tools/dev/pipeline/ci_steps.sh backend_integration_tests

            -   name: ğŸ§ª E2E Contract Tests
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_contract_tests

            # =============================================================
            # MOBILE-UMGEBUNG
            # =============================================================

            -   name: ğŸ“± Node 20 einrichten
                uses: actions/setup-node@v4
                with:
                    node-version: '20.19.4'
                    cache: 'npm'
                    cache-dependency-path: 'mobile/package-lock.json'

            -   name: ğŸ” Node-Umgebung prÃ¼fen
                run: |
                    echo "::group::Node-Umgebung"
                    node --version
                    npm --version
                    echo "::endgroup::"

            -   name: ğŸ“¦ Mobile-AbhÃ¤ngigkeiten
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_install_deps

            -   name: ğŸš‘ Expo-Konfiguration (expo-doctor)
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_expo_doctor

            -   name: âœ¨ Mobile Linting
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_lint

            -   name: ğŸ” Mobile TypeScript-Check
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_typescript_check

            -   name: ğŸ§ª Mobile Tests
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_jest_tests

            -   name: ğŸ“¦ Mobile Build
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_build

            # =============================================================
            # ABSCHLUSS
            # =============================================================

            -   name: âœ… CI-Pipeline abgeschlossen
                if: success()
                run: |
                    echo "::notice::Alle CI-PrÃ¼fungen wurden erfolgreich abgeschlossen."

            # =============================================================
            # BROWSER E2E (Playwright â€“ Minimum)
            # =============================================================

    e2e-core-minimal:
        runs-on: ubuntu-latest
        needs: [ build-and-check ]
        permissions:
            contents: read
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: ğŸ Python 3.13 einrichten (fÃ¼r Backend)
                uses: actions/setup-python@v5
                with:
                    python-version: '3.13'
                    cache: 'pip'
                    cache-dependency-path: |
                        backend/pyproject.toml
                        backend/setup.py
                        backend/requirements*.txt

            -   name: ğŸ“¦ Backend-Setup
                run: |
                    bash tools/dev/pipeline/ci_steps.sh backend_setup_env

            -   name: ğŸš€ Backend im E2E-Modus starten
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_backend_start

            -   name: ğŸ“± Node 20 einrichten
                uses: actions/setup-node@v4
                with:
                    node-version: '20.19.4'
                    cache: 'npm'
                    cache-dependency-path: |
                        mobile/package-lock.json
                        tests/e2e/browseri/playwright/package-lock.json

            -   name: ğŸ“¦ Mobile-Dependencies installieren
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_install_deps

            -   name: ğŸš€ Expo-Web im E2E-Modus starten
                env:
                    EXPO_PUBLIC_API_BASE_URL: http://127.0.0.1:8100
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_expo_web_start

            -   name: ğŸ­ Playwright-Dependencies installieren
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_playwright_install

            -   name: ğŸŒ E2E Browser Tests (Playwright â€“ Minimum)
                env:
                    PLAYWRIGHT_WEB_BASE_URL: http://localhost:19006
                    E2E_API_BASE_URL: http://127.0.0.1:8100
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_playwright_minimum_tests
            
            # Optionale erweiterte Tests (Standard: Minimum + Standard, aktivierbar fÃ¼r Feature-Branches)
            # FÃ¼r aktivierung: GitHub Workflow manuell mit Input-Parameter erweitern
            # oder in Feature-Branch-Workflow separate Job definieren mit:
            #     bash tools/dev/pipeline/ci_steps.sh e2e_playwright_standard_tests
            
            # VollstÃ¤ndige Test-Suite (inkl. Bestenfalls) fÃ¼r manuelle/Release-Runs:
            #     bash tools/dev/pipeline/ci_steps.sh e2e_playwright_all_tests

    # =============================================================
    # BROWSER E2E (Playwright â€“ Standard)
    # =============================================================

    e2e-core-standard:
        runs-on: ubuntu-latest
        needs: [ build-and-check ]
        permissions:
            contents: read
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: ğŸ Python 3.13 einrichten (fÃ¼r Backend)
                uses: actions/setup-python@v5
                with:
                    python-version: '3.13'
                    cache: 'pip'
                    cache-dependency-path: |
                        backend/pyproject.toml
                        backend/setup.py
                        backend/requirements*.txt

            -   name: ğŸ“¦ Backend-Setup
                run: |
                    bash tools/dev/pipeline/ci_steps.sh backend_setup_env

            -   name: ğŸš€ Backend im E2E-Modus starten
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_backend_start

            -   name: ğŸ“± Node 20 einrichten
                uses: actions/setup-node@v4
                with:
                    node-version: '20.19.4'
                    cache: 'npm'
                    cache-dependency-path: |
                        mobile/package-lock.json
                        tests/e2e/browseri/playwright/package-lock.json

            -   name: ğŸ“¦ Mobile-Dependencies installieren
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_install_deps

            -   name: ğŸš€ Expo-Web im E2E-Modus starten
                env:
                    EXPO_PUBLIC_API_BASE_URL: http://127.0.0.1:8100
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_expo_web_start

            -   name: ğŸ­ Playwright-Dependencies installieren
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_playwright_install

            -   name: ğŸŒ E2E Browser Tests (Playwright â€“ Standard)
                env:
                    PLAYWRIGHT_WEB_BASE_URL: http://localhost:19006
                    E2E_API_BASE_URL: http://127.0.0.1:8100
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_playwright_standard_tests

    # =============================================================
    # BROWSER E2E (Playwright â€“ Alle)
    # =============================================================

    e2e-core-all:
        runs-on: ubuntu-latest
        needs: [ build-and-check ]
        permissions:
            contents: read
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: ğŸ Python 3.13 einrichten (fÃ¼r Backend)
                uses: actions/setup-python@v5
                with:
                    python-version: '3.13'
                    cache: 'pip'
                    cache-dependency-path: |
                        backend/pyproject.toml
                        backend/setup.py
                        backend/requirements*.txt

            -   name: ğŸ“¦ Backend-Setup
                run: |
                    bash tools/dev/pipeline/ci_steps.sh backend_setup_env

            -   name: ğŸš€ Backend im E2E-Modus starten
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_backend_start

            -   name: ğŸ“± Node 20 einrichten
                uses: actions/setup-node@v4
                with:
                    node-version: '20.19.4'
                    cache: 'npm'
                    cache-dependency-path: |
                        mobile/package-lock.json
                        tests/e2e/browseri/playwright/package-lock.json

            -   name: ğŸ“¦ Mobile-Dependencies installieren
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_install_deps

            -   name: ğŸš€ Expo-Web im E2E-Modus starten
                env:
                    EXPO_PUBLIC_API_BASE_URL: http://127.0.0.1:8100
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_expo_web_start

            -   name: ğŸ­ Playwright-Dependencies installieren
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_playwright_install

            -   name: ğŸŒ E2E Browser Tests (Playwright â€“ Alle)
                env:
                    PLAYWRIGHT_WEB_BASE_URL: http://localhost:19006
                    E2E_API_BASE_URL: http://127.0.0.1:8100
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_playwright_all_tests