name: CI

on:
    push:
        branches: [ "main", "master" ]
    pull_request:
        branches: [ "**" ]

jobs:
    py_backend:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            pull-requests: write
            actions: read
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: üêç Python 3.13 einrichten
                uses: actions/setup-python@v5
                with:
                    python-version: '3.13'

            -   name: üì¶ Install uv
                uses: astral-sh/setup-uv@v5
                with:
                    enable-cache: true
                    cache-dependency-glob: "uv.lock"

            -   name: üîç Python-Umgebung pr√ºfen
                run: |
                    echo "::group::Python-Umgebung"
                    uv --version
                    python3 --version
                    echo "::endgroup::"

            -   name: üöÄ Backend Pipeline
                run: |
                    bash tools/dev/pipeline/ci_steps.sh pipeline_backend

            -   name: üß™ E2E Contract Tests
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_contract_tests

            # =============================================================
            # FAILURE HANDLING (Backend)
            # =============================================================
            -   name: üõ†Ô∏è Collect Failure Data
                if: failure()
                uses: ./.github/actions/failure-collector

            -   name: üì§ Upload Failure Artifact
                if: failure()
                uses: actions/upload-artifact@v4
                with:
                    name: ci-failure-logs-py_backend
                    path: ci_failure_bundle/
                    retention-days: 7

            -   name: üìù Write Job Summary
                if: failure()
                shell: bash
                run: |
                    echo "## ‚ùå CI Job Failed: py_backend" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "üîç **Details:**" >> $GITHUB_STEP_SUMMARY
                    echo "- **Run:** [View Run Log](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
                    echo "- **Artifact:** \`ci-failure-logs-py_backend\`" >> $GITHUB_STEP_SUMMARY

    js_mobile:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            pull-requests: write
            actions: read
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: üì± Node 20 einrichten
                uses: actions/setup-node@v4
                with:
                    node-version: '20.x'

            -   name: üì¶ Install pnpm
                uses: pnpm/action-setup@v4
                with:
                    version: 9.15.0
                    run_install: false

            -   name: ‚ôªÔ∏è Get pnpm store directory
                shell: bash
                run: |
                    echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT
                id: pnpm-cache

            -   name: ‚ôªÔ∏è Setup pnpm cache
                uses: actions/cache@v4
                with:
                    path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
                    key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
                    restore-keys: |
                        ${{ runner.os }}-pnpm-store-

            -   name: üîç Node-Umgebung pr√ºfen
                run: |
                    echo "::group::Node-Umgebung"
                    node --version
                    pnpm --version
                    echo "::endgroup::"

            -   name: üöÄ Mobile Pipeline
                run: |
                    bash tools/dev/pipeline/ci_steps.sh pipeline_mobile

            # =============================================================
            # FAILURE HANDLING (Mobile)
            # =============================================================
            -   name: üõ†Ô∏è Collect Failure Data
                if: failure()
                uses: ./.github/actions/failure-collector

            -   name: üì§ Upload Failure Artifact
                if: failure()
                uses: actions/upload-artifact@v4
                with:
                    name: ci-failure-logs-js_mobile
                    path: ci_failure_bundle/
                    retention-days: 7

            -   name: üìù Write Job Summary
                if: failure()
                shell: bash
                run: |
                    echo "## ‚ùå CI Job Failed: js_mobile" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "üîç **Details:**" >> $GITHUB_STEP_SUMMARY
                    echo "- **Run:** [View Run Log](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
                    echo "- **Artifact:** \`ci-failure-logs-js_mobile\`" >> $GITHUB_STEP_SUMMARY

    secrets:
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout
                uses: actions/checkout@v4
                with:
                    fetch-depth: 0
            -   name: üõ°Ô∏è Gitleaks
                uses: gitleaks/gitleaks-action@v2
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    codeql:
        runs-on: ubuntu-latest
        permissions:
            actions: read
            contents: read
            security-events: write
        steps:
            -   name: Checkout
                uses: actions/checkout@v4
            -   name: Initialize CodeQL
                uses: github/codeql-action/init@v3
                with:
                    languages: javascript, python
            -   name: Perform CodeQL Analysis
                uses: github/codeql-action/analyze@v3

    e2e-core-minimal:
        runs-on: ubuntu-latest
        needs: [ py_backend, js_mobile ]
        permissions:
            contents: read
            pull-requests: write
            actions: read
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: üêç Python 3.13 einrichten (f√ºr Backend)
                uses: actions/setup-python@v5
                with:
                    python-version: '3.13'

            -   name: üì¶ Install uv
                uses: astral-sh/setup-uv@v5
                with:
                    enable-cache: true
                    cache-dependency-glob: "uv.lock"

            -   name: üì¶ Backend-Setup
                run: |
                    bash tools/dev/pipeline/ci_steps.sh backend_setup_env

            -   name: üöÄ Backend im E2E-Modus starten
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_backend_start

            -   name: üì± Node 20 einrichten
                uses: actions/setup-node@v4
                with:
                    node-version: '20.x'

            -   name: üì¶ Install pnpm
                uses: pnpm/action-setup@v4
                with:
                    version: 9.15.0
                    run_install: false

            -   name: üì¶ Mobile-Dependencies installieren
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_install_deps

            -   name: üöÄ Expo-Web im E2E-Modus starten
                env:
                    EXPO_PUBLIC_API_BASE_URL: http://127.0.0.1:8100
                    HW_PROFILE: e2e
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_expo_web_start

            -   name: üé≠ Playwright-Dependencies installieren
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_playwright_install

            -   name: üåê E2E Browser Tests (Playwright ‚Äì Minimal)
                env:
                    PLAYWRIGHT_WEB_BASE_URL: http://localhost:19006
                    E2E_API_BASE_URL: http://127.0.0.1:8100
                    HW_PROFILE: e2e
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_playwright_minimal_tests

            # =============================================================
            # FAILURE HANDLING
            # =============================================================

            -   name: üõ†Ô∏è Collect Failure Data
                if: failure()
                uses: ./.github/actions/failure-collector

            -   name: üì§ Upload Failure Artifact
                if: failure()
                uses: actions/upload-artifact@v4
                with:
                    name: ci-failure-logs-${{ github.job }}
                    path: ci_failure_bundle/
                    retention-days: 7

            -   name: üìù Write Job Summary
                if: failure()
                shell: bash
                run: |
                    echo "## ‚ùå CI Job Failed: ${{ github.job }}" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "üîç **Details:**" >> $GITHUB_STEP_SUMMARY
                    echo "- **Run:** [View Run Log](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
                    echo "- **Artifact:** \`ci-failure-logs-${{ github.job }}\`" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "üöÄ **Next Steps (Terminal):**" >> $GITHUB_STEP_SUMMARY
                    echo "Um die Fehler lokal zu analysieren:" >> $GITHUB_STEP_SUMMARY
                    echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
                    echo "./tools/ci/ci-last-failed-log.sh" >> $GITHUB_STEP_SUMMARY
                    echo "./tools/ci/ci-download-artifacts-last-run.sh" >> $GITHUB_STEP_SUMMARY
                    echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

            -   name: üí¨ PR Comment on Failure
                if: failure() && github.event_name == 'pull_request'
                uses: peter-evans/create-or-update-comment@v4
                with:
                    issue-number: ${{ github.event.pull_request.number }}
                    body: |
                        ## ‚ùå CI Job Failed: ${{ github.job }}
                        Der CI-Job **${{ github.job }}** ist fehlgeschlagen.

                        - **Run Log:** [View here](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
                        - **Artefakt:** `ci-failure-logs-${{ github.job }}`

                        Lokale Analyse:
                        ```bash
                        ./tools/ci/ci-last-failed-log.sh
                        ```

    # =============================================================
    # BROWSER E2E (Playwright ‚Äì STANDARD)
    # =============================================================

    e2e-core-standard:
        runs-on: ubuntu-latest
        needs: [ py_backend, js_mobile ]
        permissions:
            contents: read
            pull-requests: write
            actions: read
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: üêç Python 3.13 einrichten (f√ºr Backend)
                uses: actions/setup-python@v5
                with:
                    python-version: '3.13'

            -   name: üì¶ Install uv
                uses: astral-sh/setup-uv@v5
                with:
                    enable-cache: true
                    cache-dependency-glob: "uv.lock"

            -   name: üì¶ Backend-Setup
                run: |
                    bash tools/dev/pipeline/ci_steps.sh backend_setup_env

            -   name: üöÄ Backend im E2E-Modus starten
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_backend_start

            -   name: üì± Node 20 einrichten
                uses: actions/setup-node@v4
                with:
                    node-version: '20.x'

            -   name: üì¶ Install pnpm
                uses: pnpm/action-setup@v4
                with:
                    version: 9.15.0
                    run_install: false

            -   name: üì¶ Mobile-Dependencies installieren
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_install_deps

            -   name: üöÄ Expo-Web im E2E-Modus starten
                env:
                    EXPO_PUBLIC_API_BASE_URL: http://127.0.0.1:8100
                    HW_PROFILE: e2e
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_expo_web_start

            -   name: üé≠ Playwright-Dependencies installieren
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_playwright_install

            -   name: üåê E2E Browser Tests (Playwright ‚Äì Standard)
                env:
                    PLAYWRIGHT_WEB_BASE_URL: http://localhost:19006
                    E2E_API_BASE_URL: http://127.0.0.1:8100
                    HW_PROFILE: e2e
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_playwright_standard_tests

            # =============================================================
            # FAILURE HANDLING
            # =============================================================

            -   name: üõ†Ô∏è Collect Failure Data
                if: failure()
                uses: ./.github/actions/failure-collector

            -   name: üì§ Upload Failure Artifact
                if: failure()
                uses: actions/upload-artifact@v4
                with:
                    name: ci-failure-logs-${{ github.job }}
                    path: ci_failure_bundle/
                    retention-days: 7

            -   name: üìù Write Job Summary
                if: failure()
                shell: bash
                run: |
                    echo "## ‚ùå CI Job Failed: ${{ github.job }}" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "üîç **Details:**" >> $GITHUB_STEP_SUMMARY
                    echo "- **Run:** [View Run Log](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
                    echo "- **Artifact:** \`ci-failure-logs-${{ github.job }}\`" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "üöÄ **Next Steps (Terminal):**" >> $GITHUB_STEP_SUMMARY
                    echo "Um die Fehler lokal zu analysieren:" >> $GITHUB_STEP_SUMMARY
                    echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
                    echo "./tools/ci/ci-last-failed-log.sh" >> $GITHUB_STEP_SUMMARY
                    echo "./tools/ci/ci-download-artifacts-last-run.sh" >> $GITHUB_STEP_SUMMARY
                    echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

            -   name: üí¨ PR Comment on Failure
                if: failure() && github.event_name == 'pull_request'
                uses: peter-evans/create-or-update-comment@v4
                with:
                    issue-number: ${{ github.event.pull_request.number }}
                    body: |
                        ## ‚ùå CI Job Failed: ${{ github.job }}
                        Der CI-Job **${{ github.job }}** ist fehlgeschlagen.

                        - **Run Log:** [View here](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
                        - **Artefakt:** `ci-failure-logs-${{ github.job }}`

                        Lokale Analyse:
                        ```bash
                        ./tools/ci/ci-last-failed-log.sh
                        ```