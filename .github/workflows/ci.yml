name: CI

on:
    push:
        branches: [ "main", "master" ]
    pull_request:
        branches: [ "**" ]

jobs:
    build-and-check:
        runs-on: ubuntu-latest
        permissions:
            contents: read

        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            # =============================================================
            # BACKEND-UMGEBUNG
            # =============================================================

            -   name: üêç Python 3.13 einrichten
                uses: actions/setup-python@v5
                with:
                    python-version: '3.13'
                    cache: 'pip'
                    cache-dependency-path: |
                        backend/pyproject.toml
                        backend/setup.py
                        backend/requirements*.txt

            -   name: üîç Python-Umgebung pr√ºfen
                run: |
                    echo "::group::Python-Umgebung"
                    python3 --version
                    pip --version
                    echo "::endgroup::"

            -   name: üì¶ Backend-Setup
                run: |
                    bash tools/dev/pipeline/ci_steps.sh backend_setup_env

            -   name: ‚ú® Backend-Qualit√§t (Ruff + MyPy)
                run: |
                    bash tools/dev/pipeline/ci_steps.sh backend_quality

            -   name: üß™ Backend Unit-Tests
                run: |
                    bash tools/dev/pipeline/ci_steps.sh backend_unit_tests

            -   name: üß™ Backend Integrationstests
                run: |
                    bash tools/dev/pipeline/ci_steps.sh backend_integration_tests

            -   name: üß™ E2E Contract Tests
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_contract_tests

            # =============================================================
            # MOBILE-UMGEBUNG
            # =============================================================

            -   name: üì± Node 20 einrichten
                uses: actions/setup-node@v4
                with:
                    node-version: '20.19.4'
                    cache: 'npm'
                    cache-dependency-path: 'mobile/package-lock.json'

            -   name: üîç Node-Umgebung pr√ºfen
                run: |
                    echo "::group::Node-Umgebung"
                    node --version
                    npm --version
                    echo "::endgroup::"

            -   name: üì¶ Mobile-Abh√§ngigkeiten
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_install_deps

            -   name: üöë Expo-Konfiguration (expo-doctor)
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_expo_doctor

            -   name: ‚ú® Mobile Linting
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_lint

            -   name: üîç Mobile TypeScript-Check
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_typescript_check

            -   name: üß™ Mobile Tests (Jest, falls vorhanden)
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_jest_tests

            -   name: üì¶ Mobile Build (falls vorhanden)
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_build

            # =============================================================
            # ABSCHLUSS
            # =============================================================

            -   name: ‚úÖ CI-Pipeline abgeschlossen
                if: success()
                run: |
                    echo "::notice::Alle CI-Pr√ºfungen wurden erfolgreich abgeschlossen."

            # =============================================================
            # BROWSER E2E (Playwright ‚Äì Minimum)
            # =============================================================

    e2e-core-minimal:
        runs-on: ubuntu-latest
        needs: [ build-and-check ]
        permissions:
            contents: read
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: üêç Python 3.13 einrichten (f√ºr Backend)
                uses: actions/setup-python@v5
                with:
                    python-version: '3.13'
                    cache: 'pip'
                    cache-dependency-path: |
                        backend/pyproject.toml
                        backend/setup.py
                        backend/requirements*.txt

            -   name: üì¶ Backend-Setup
                run: |
                    bash tools/dev/pipeline/ci_steps.sh backend_setup_env

            -   name: üöÄ Backend im E2E-Modus starten
                run: |
                    bash backend/tools/start_test_backend_e2e.sh &
                    echo "Warte auf Backend /health..."
                    for i in {1..60}; do
                      if curl -fsS http://127.0.0.1:8100/health >/dev/null; then
                        echo "Backend ist bereit."
                        break
                      fi
                      sleep 1
                    done

            -   name: üì± Node 20 einrichten
                uses: actions/setup-node@v4
                with:
                    node-version: '20.19.4'
                    cache: 'npm'
                    cache-dependency-path: 'tests/e2e/browseri/playwright/package-lock.json'

            -   name: üåê E2E Browser Tests (Playwright ‚Äì Minimum)
                env:
                    E2E_API_BASE_URL: http://127.0.0.1:8100
                run: |
                    cd tests/e2e/browseri/playwright
                    npm install
                    npx playwright install --with-deps chromium
                    npx playwright test specs/auth.basic.spec.ts \
                                         specs/widgets.basic.spec.ts \
                                         specs/widgets.security.spec.ts \
                                         specs/infra.health.spec.ts