name: CI

on:
    push:
        branches: [ "main", "master" ]
    pull_request:
        branches: [ "**" ]

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # =============================================================
    # PFAD-FILTER (Ressourcen-Optimierung)
    # =============================================================
    changes:
        name: üîç Detect Changes
        runs-on: ubuntu-latest
        outputs:
            backend: ${{ steps.filter.outputs.backend }}
            mobile: ${{ steps.filter.outputs.mobile }}
            ios: ${{ steps.filter.outputs.ios }}
            e2e: ${{ steps.filter.outputs.e2e }}
        steps:
            -   uses: actions/checkout@v4
            -   uses: dorny/paths-filter@v3
                id: filter
                with:
                    filters: |
                        backend:
                          - 'backend/**'
                          - 'tools/**'
                          - '.github/workflows/ci.yml'
                          - '.github/actions/setup-backend/**'
                        mobile:
                          - 'mobile/**'
                          - 'tools/**'
                          - '.github/workflows/ci.yml'
                          - '.github/actions/setup-mobile/**'
                        ios:
                          - 'ios/**'
                          - 'tools/**'
                          - '.github/workflows/ci.yml'
                        e2e:
                          - 'backend/**'
                          - 'mobile/**'
                          - 'tests/e2e/**'
                          - 'tools/**'
                          - '.github/workflows/ci.yml'
                          - '.github/actions/**'

    # =============================================================
    # BACKEND-PR√úFUNGEN
    # =============================================================
    backend-check:
        name: üêç Backend Quality & Tests
        needs: [ changes ]
        if: needs.changes.outputs.backend == 'true'
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Setup Backend
                uses: ./.github/actions/setup-backend

            -   name: üîç Python-Umgebung pr√ºfen
                run: |
                    echo "::group::Python-Umgebung"
                    python3 --version
                    pip --version
                    echo "::endgroup::"

            -   name: ‚ú® Backend-Qualit√§t (Ruff + MyPy)
                run: |
                    bash tools/dev/pipeline/ci_steps.sh backend_quality

            -   name: üß™ Backend Unit-Tests
                run: |
                    bash tools/dev/pipeline/ci_steps.sh backend_unit_tests

            -   name: üß™ Backend Integrationstests
                run: |
                    bash tools/dev/pipeline/ci_steps.sh backend_integration_tests

            -   name: üß™ E2E Contract Tests
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_contract_tests

    # =============================================================
    # MOBILE-PR√úFUNGEN
    # =============================================================
    mobile-check:
        name: üì± Mobile Quality & Tests
        needs: [ changes ]
        if: needs.changes.outputs.mobile == 'true'
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Setup Mobile
                uses: ./.github/actions/setup-mobile

            -   name: üîç Node-Umgebung pr√ºfen
                run: |
                    echo "::group::Node-Umgebung"
                    node --version
                    npm --version
                    echo "::endgroup::"

            -   name: üöë Expo-Konfiguration (expo-doctor)
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_expo_doctor

            -   name: ‚ú® Mobile Linting
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_lint

            -   name: üîç Mobile TypeScript-Check
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_typescript_check

            -   name: ‚ôªÔ∏è Restore Jest/Babel Cache
                uses: actions/cache@v4
                with:
                    path: |
                        mobile/.cache/jest
                        mobile/.cache/babel.json
                    key: jest-babel-${{ runner.os }}-${{ hashFiles('mobile/package-lock.json') }}

            -   name: üß™ Mobile Tests
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_jest_tests

            -   name: üì¶ Mobile Build
                run: |
                    bash tools/dev/pipeline/ci_steps.sh mobile_build

    # =============================================================
    # IOS-JOB (MacOS f√ºr Xcode)
    # =============================================================
    ios-check:
        name: üçé iOS Build & Sanity
        needs: [ changes ]
        if: needs.changes.outputs.ios == 'true'
        runs-on: macos-latest
        permissions:
            contents: read
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: üõ†Ô∏è Install Bash 5 (macOS)
                run: |
                    brew install bash
                    echo "/opt/homebrew/bin" >> $GITHUB_PATH

            -   name: üîç iOS Project Sanity Check
                run: |
                    bash tools/dev/pipeline/ci_steps.sh ios_project_sanity

            -   name: üì¶ iOS Resolve Dependencies
                run: |
                    bash tools/dev/pipeline/ci_steps.sh ios_resolve_deps

            -   name: üì¶ iOS Build
                run: |
                    bash tools/dev/pipeline/ci_steps.sh ios_build

            -   name: üß™ iOS Tests
                run: |
                    bash tools/dev/pipeline/ci_steps.sh ios_tests

    # =============================================================
    # CI GATE: Health + Demo-Feed + Playwright Gate Spec
    # =============================================================
    e2e-ci-gate:
        name: ü©∫ E2E System Gate
        needs: [ changes, backend-check, mobile-check ]
        if: |
            always() &&
            needs.changes.outputs.e2e == 'true' &&
            (needs.backend-check.result == 'success' || needs.backend-check.result == 'skipped') &&
            (needs.mobile-check.result == 'success' || needs.mobile-check.result == 'skipped')
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Setup Backend
                uses: ./.github/actions/setup-backend

            -   name: üöÄ Backend im E2E-Modus starten
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_backend_start

            -   name: Setup Mobile
                uses: ./.github/actions/setup-mobile

            -   name: üöÄ Expo-Web im E2E-Modus starten
                env:
                    EXPO_PUBLIC_API_BASE_URL: http://127.0.0.1:8100
                    HW_PROFILE: e2e
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_expo_web_start

            -   name: ü©∫ System Gate Checks (Health + Demo-Feed)
                env:
                    E2E_API_BASE_URL: http://127.0.0.1:8100
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_gate_checks

            -   name: Setup Playwright
                uses: ./.github/actions/setup-playwright

            -   name: üåê Playwright Gate Spec
                env:
                    PLAYWRIGHT_WEB_BASE_URL: http://localhost:19006
                    E2E_API_BASE_URL: http://127.0.0.1:8100
                    HW_PROFILE: e2e
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_playwright_gate_tests

    # =============================================================
    # BROWSER E2E (Playwright ‚Äì Minimal)
    # =============================================================
    e2e-core-minimal:
        name: üé≠ E2E Minimal
        needs: [ changes, e2e-ci-gate ]
        if: needs.changes.outputs.e2e == 'true' && needs.e2e-ci-gate.result == 'success'
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Setup Backend
                uses: ./.github/actions/setup-backend

            -   name: üöÄ Backend im E2E-Modus starten
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_backend_start

            -   name: Setup Mobile
                uses: ./.github/actions/setup-mobile

            -   name: üöÄ Expo-Web im E2E-Modus starten
                env:
                    EXPO_PUBLIC_API_BASE_URL: http://127.0.0.1:8100
                    HW_PROFILE: e2e
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_expo_web_start

            -   name: Setup Playwright
                uses: ./.github/actions/setup-playwright

            -   name: üåê E2E Browser Tests (Playwright ‚Äì Minimal)
                env:
                    PLAYWRIGHT_WEB_BASE_URL: http://localhost:19006
                    E2E_API_BASE_URL: http://127.0.0.1:8100
                    HW_PROFILE: e2e
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_playwright_minimal_tests

    # =============================================================
    # BROWSER E2E (Playwright ‚Äì STANDARD)
    # =============================================================
    e2e-core-standard:
        name: üé≠ E2E Standard
        needs: [ changes, e2e-ci-gate ]
        if: needs.changes.outputs.e2e == 'true' && needs.e2e-ci-gate.result == 'success'
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Setup Backend
                uses: ./.github/actions/setup-backend

            -   name: üöÄ Backend im E2E-Modus starten
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_backend_start

            -   name: Setup Mobile
                uses: ./.github/actions/setup-mobile

            -   name: üöÄ Expo-Web im E2E-Modus starten
                env:
                    EXPO_PUBLIC_API_BASE_URL: http://127.0.0.1:8100
                    HW_PROFILE: e2e
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_expo_web_start

            -   name: Setup Playwright
                uses: ./.github/actions/setup-playwright

            -   name: üåê E2E Browser Tests (Playwright ‚Äì Standard)
                env:
                    PLAYWRIGHT_WEB_BASE_URL: http://localhost:19006
                    E2E_API_BASE_URL: http://127.0.0.1:8100
                    HW_PROFILE: e2e
                run: |
                    bash tools/dev/pipeline/ci_steps.sh e2e_playwright_standard_tests

    # =============================================================
    # ABSCHLUSS
    # =============================================================
    finish:
        name: ‚úÖ CI Success
        runs-on: ubuntu-latest
        needs: [ changes, backend-check, mobile-check, ios-check, e2e-ci-gate, e2e-core-minimal, e2e-core-standard ]
        if: always()
        steps:
            - name: üèÅ Ergebnisse auswerten
              env:
                RESULTS: |
                  changes=${{ needs.changes.result }}
                  backend-check=${{ needs.backend-check.result }}
                  mobile-check=${{ needs.mobile-check.result }}
                  ios-check=${{ needs.ios-check.result }}
                  e2e-ci-gate=${{ needs.e2e-ci-gate.result }}
                  e2e-core-minimal=${{ needs.e2e-core-minimal.result }}
                  e2e-core-standard=${{ needs.e2e-core-standard.result }}
              run: |
                set +e
                echo "--- CI RESULTS ---"
                echo "$RESULTS"
                echo "------------------"
                
                FAILED_JOBS=""
                SUCCESS_COUNT=0
                TOTAL_COUNT=0
                
                while IFS='=' read -r job result || [[ -n "$job" ]]; do
                  [[ -z "$job" ]] && continue
                  ((TOTAL_COUNT++))
                  if [[ "$result" == "success" || "$result" == "skipped" ]]; then
                    ((SUCCESS_COUNT++))
                  else
                    FAILED_JOBS="$FAILED_JOBS $job($result)"
                  fi
                done <<< "$RESULTS"
                
                echo "Summary: $SUCCESS_COUNT/$TOTAL_COUNT jobs passed or skipped."
                
                if [[ $SUCCESS_COUNT -eq $TOTAL_COUNT ]] && [[ $TOTAL_COUNT -gt 0 ]]; then
                  echo "::notice title=CI Success::Alle $TOTAL_COUNT relevanten CI-Jobs wurden erfolgreich abgeschlossen (oder √ºbersprungen)."
                else
                  echo "::error title=CI Failure::Folgende Jobs sind fehlgeschlagen oder wurden abgebrochen:$FAILED_JOBS"
                  exit 1
                fi