name: CI

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["**"]

jobs:
  build-and-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # =================================================================
      # BACKEND CHECKS
      # =================================================================
      
      - name: üêç Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
          cache-dependency-path: |
            backend/pyproject.toml
            backend/setup.py
            backend/requirements*.txt

      - name: üîç Verify Python version
        run: |
          echo "::group::Python Environment Info"
          python3 --version
          pip --version
          echo "::endgroup::"

      - name: üì¶ Backend dev env setup (parity with local)
        run: |
          echo "::group::Backend Setup"
          bash tools/dev/setup_dev_env.sh
          echo "::endgroup::"
        env:
          PYTHON_BIN: python3

      - name: ‚ú® Backend quality (ruff + mypy)
        run: |
          echo "::group::Backend Quality Checks"
          bash tools/dev/quality.sh
          echo "::endgroup::"
        shell: bash

      - name: üß™ Backend tests (pytest)
        run: |
          set -euo pipefail
          echo "::group::Backend Tests"
          
          # Check if tests exist
          if [ -d "backend/tests" ] || find backend \( -name '*_test.py' -o -name 'test_*.py' \) | grep -q .; then
            echo "‚úì Tests found, running pytest..."
            
            # Activate venv and run pytest
            source backend/.venv/bin/activate
            
            if command -v pytest >/dev/null 2>&1; then
              pytest backend/tests -v --tb=short || {
                echo "::error::Backend tests failed"
                exit 1
              }
            else
              echo "::error::pytest not found in venv"
              exit 1
            fi
          else
            echo "‚ÑπÔ∏è  No tests found ‚Äì skipping test step"
          fi
          
          echo "::endgroup::"

      # =================================================================
      # MOBILE CHECKS
      # =================================================================
      
      - name: üì± Set up Node 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'mobile/package-lock.json'

      - name: üîç Verify Node version
        run: |
          echo "::group::Node Environment Info"
          node --version
          npm --version
          echo "::endgroup::"

      - name: üì¶ Mobile install dependencies
        working-directory: mobile
        run: |
          echo "::group::Mobile Dependencies"
          npm ci --no-fund --no-audit || {
            echo "::error::Failed to install mobile dependencies"
            exit 1
          }
          echo "::endgroup::"

      - name: ‚ú® Mobile lint
        working-directory: mobile
        run: |
          echo "::group::Mobile Linting"
          npm run lint || {
            echo "::error::Mobile linting failed"
            exit 1
          }
          echo "::endgroup::"

      - name: üîç Mobile typecheck
        working-directory: mobile
        run: |
          echo "::group::Mobile TypeScript Check"
          npx tsc --noEmit || {
            echo "::error::Mobile type checking failed"
            exit 1
          }
          echo "::endgroup::"

      - name: üì¶ Mobile build check (if script exists)
        working-directory: mobile
        run: |
          echo "::group::Mobile Build Check"
          if jq -e '.scripts.build' package.json > /dev/null 2>&1; then
            echo "‚úì Build script found, running build..."
            npm run build || {
              echo "::error::Mobile build failed"
              exit 1
            }
          else
            echo "‚ÑπÔ∏è  No build script defined ‚Äì skipping build step"
          fi
          echo "::endgroup::"
      
      # =================================================================
      # SUMMARY
      # =================================================================
      
      - name: ‚úÖ CI Pipeline Complete
        if: success()
        run: |
          echo "::notice::All CI checks passed successfully! üéâ"
